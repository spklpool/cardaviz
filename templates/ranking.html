<!DOCTYPE html>
<html>
<head>
<style>
  <style>
    html,
    body {
        margin: 0;
        height: 100%;
        width: 95%;
    }

    .arrow:hover {
      cursor: pointer;
    }

    .arrow {
      border: solid white;
      border-width: 0 3px 3px 0;
      display: inline-block;
      padding: 3px;
    }

    .up {
      transform: rotate(-135deg);
      -webkit-transform: rotate(-135deg);
    }

    .down {
      transform: rotate(45deg);
      -webkit-transform: rotate(45deg);
    }

    .tableClass {
      margin: 10px;
      height: 100%;
      width: 100%;
      border: 0px solid;
      border-collapse: collapse;
      border-spacing: 0;
      border-radius: 25px;
    }
    h1,h2,h3,h4 {
      color: white;
    }
    a:link {
      color: white;
      background-color: transparent;
      text-decoration: none;
    }
    a:visited {
      color: white;
      background-color: transparent;
      text-decoration: none;
    }
    a:hover {
      background-color: transparent;
      text-decoration: underline;
    }
    a:active {
      color: yellow;
      background-color: transparent;
      text-decoration: underline;
    }
    table {
      color: white;
      border-spacing: 20px;
      border-radius: 25px;
    }
  </style>
</style>
</head>
<body  style="background-color: black;">
<script type="text/javascript" src="../static/js/paper-full.js"></script>
<script type="text/javascript" src="../static/js/StakePoolPerformanceChart.js"></script>
<script>
var pools_to_render = [];
{% for pool in ranking['results'] %}
pools_to_render.push('{{pool['ticker']}}');
{% endfor %}
var ready_to_render = false;
var pool_json_client_cache = {};

draw_if_page_finished_loading();

window.addEventListener("resize", (event) => {
    if (ready_to_render) {
        console.log('resize');
        draw_if_page_finished_loading();
    }
});

window.addEventListener("pageshow", () => {
    console.log('pageshow');
    if (ready_to_render) {
        draw_if_page_finished_loading();
    }
});

document.addEventListener('readystatechange', (event) => {
    if (document.readyState === "complete") {
        ready_to_render = true;
    }
});

function draw_if_page_finished_loading() {
    if (ready_to_render) {
        var Table = document.getElementById("canvas_table");
        Table.innerHTML = "<tbody><tbody>";
        for (var i=0; i<pools_to_render.length; i++) {
            if (pools_to_render[i].toUpperCase() in pool_json_client_cache) {
                console.log('rendering from client cache');
                render_pool_thumbnail(pool_json_client_cache[pools_to_render[i].toUpperCase()]);
            } else {
                var data_url = '/data/' + pools_to_render[i].toUpperCase() + '.json';
                console.log('fetching data from ' + data_url);
                fetch(data_url)
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {
                    console.log('data fetch completed for ' + data['ticker']);
                    pool_json_client_cache[data['ticker'].toUpperCase()] = data;
                    render_pool_thumbnail(data);
                })
                .catch(function (err) {
                    console.log('error: ' + err);
                });
            }
        }
    } else {
        setTimeout(draw_if_page_finished_loading, 100);
    }
}

function render_pool_thumbnail(data) {
    var canvasCellHTML = '<td><a href="../pools/' + data['ticker'] + '"><canvas id="' + data['ticker'] + '" resize></canvas></a></td>'
    var tableRef = document.getElementById('canvas_table').getElementsByTagName('tbody')[0];
    var newRow = tableRef.insertRow(tableRef.rows.length);
    newRow.innerHTML = canvasCellHTML;
    paper.install(window);
    var canvas = document.getElementById(data['ticker'])
    canvas.width = window.innerWidth - 50
    paper.setup(canvas);
    chart = new StakePoolPerformanceChart(canvas, paper, data, document, true);
    chart.draw(false, false);
}

var expandable_details_visibility = false;
function toggle_expandable_details() {
  var div = document.getElementById('expandable_details');
  var button = document.getElementById('clickable_expand_div');
  if (expandable_details_visibility) {
    expandable_details_visibility = false;
    div.style.display = 'none';
    div.style.visibility = 'hidden';
    button.innerHTML = "<p><center><i class=\"arrow down\"></i></center></p>";
  } else {
    expandable_details_visibility = true;
    div.style.display = 'block';
    div.style.visibility = 'visible';
    button.innerHTML = "<p><center><i class=\"arrow up\"></i></center></p>";
  }
}
</script>
<h1><center>{{ranking['pretty_name']}}</center></h1>
<h2><center>{{ranking['summary']}}</center></h2>
<div id="expandable_details" style="display: none;">
  <center>
  <table bgcolor="#303030">
    <tr>
      <td><b>Ranking Description:</b></td>
      <td>{{ranking['description']}}</td>
    </tr>
    <tr>
      <td><b>Ranking Expression:</b></td>
      <td>{{ranking['expression']}}</td>
    </tr>
    <tr>
      <td><b>Ranking Expression Explanation:</b></td>
      <td>{{ranking['expression_explanation']}}</td>
    </tr>
    <tr>
      <td><b>Filters:</b></td>
      <td>Below is a list of additional filters that are applied to the resulting pools</td>
    </tr>
{% for filter in ranking['filters'] %}
    <tr>
      <td><b>{{filter['name']}}</b></td>
      <td>{{filter['expression']}}</td>
    </tr>
{% endfor %}
  </table>
  </center>
</div>
<div>
  <div id="clickable_expand_div" onclick="toggle_expandable_details()"><p><center><i class="arrow down"></i></center></p></div>
  <table class="tableClass" id="canvas_table" width="100%" cellpadding="0" cellspacing="0" border="0">
    <tbody><tbody>
  </table>
</div>
</body>
</html>